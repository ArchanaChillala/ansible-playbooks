---
- hosts: vagrant
  vars:
    yuic_url: https://github.com/downloads/yui/yuicompressor
    yuic_name: yuicompressor-2.4.2
    node_version: 0.10.25
    node_prefix: "node-v{{ node_version }}"
    node_tarball: "{{ node_prefix }}.tar.gz"
    node_path: "/usr/local"
  user: vagrant
  sudo: yes # Because YUI Compressor is installed system-wide

  # TODO: we need to add jvm-x.yaml as a dependency, because we need Java to run the YUI Compressor
  # In the meantime, run a jvm playbook manually:
  #
  # ansible-playbook /vagrant/ansible-playbooks/generic/jvm/jvm-6.yaml --inventory-file=/home/vagrant/ansible_hosts --connection=local

  tasks:

    - name: Ensure unzip is installed
      apt: pkg=unzip state=installed
      tags: [yuic]

    - name: Ensure YUI Compressor is downloaded
      get_url: dest=/tmp/ url={{ yuic_url }}/{{ yuic_name }}.zip
      tags: [yuic]

    - name: Ensure YUI Compressor is extracted 
      shell: unzip -o /tmp/{{ yuic_name }}.zip -d /usr/local/share creates=/usr/local/share/{{ yuic_name }}
      tags: [yuic]

    - name: Ensure YUI_COMPRESSOR_PATH is exported
      lineinfile: dest=/etc/environment
                  regexp='^YUI_COMPRESSOR_PATH'
                  line='YUI_COMPRESSOR_PATH=/usr/local/share/{{ yuic_name }}'
                  state=present
      tags: [yuic]

    # TODO: this should really be an external dependency

    - name: Node.js | Checking installed version of node.js
      shell: /usr/bin/test "$(node -v 2> /dev/null)" = v{{ node_version }}
      register: wanted_version_installed
      ignore_errors: True

    - name: Node.js | Fetching node.js source
      action: get_url url=http://nodejs.org/dist/v{{ node_version }}/{{ node_tarball }} dest=/tmp/
      when: wanted_version_installed.rc == 1

    - name: Node.js | Unpack node.js tarball
      command: tar zxf {{ node_tarball }} chdir=/tmp
      when: wanted_version_installed.rc == 1

    - name: Node.js | Configure
      shell: /usr/bin/python ./configure --prefix={{ node_path }} chdir=/tmp/{{ node_prefix }}
      when: wanted_version_installed.rc == 1

    - name: Node.js | Make
      shell: /usr/bin/make chdir=/tmp/{{ node_prefix }}/
      when: wanted_version_installed.rc == 1

    - name: Node.js | Make install
      shell: /usr/bin/make install chdir=/tmp/{{ node_prefix }}/
      when: wanted_version_installed.rc == 1

    - name: Grunt | Grunt CLI install
      shell: npm install -g grunt-cli
